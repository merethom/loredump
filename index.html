<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noxsyphone Loredump</title>
    <script src="https://kit.fontawesome.com/d0544f08d4.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/design.css">
    <link rel="stylesheet" href="css/handcode.css">
</head>

<body>


    <!-- Sign-in screen (shown when not authenticated) -->
    <div id="signInScreen" class="sign-in-screen">
        <div class="sign-in-card">
            <img src="img/raygun.svg" alt="" class="sign-in-logo">
            <h1 class="sign-in-title">Noxsyphone Lore Dump</h1>
            <p class="sign-in-subtitle">Sign in with Google to continue</p>
            <button type="button" id="signInBtn" class="sign-in-btn">
                <i class="fa-brands fa-google"></i>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main app (shown when authenticated) -->
    <div id="appContent" class="container" style="display: none;">
        <header>
            <img src="img/raygun.svg" alt="raygun">
            <h1>Noxsyphone Lore Dump</h1>
            <div class="header-actions">
                <span id="userEmail" class="user-email"></span>
                <button id="signOutBtn" class="control-btn control-btn-icon" title="Sign out">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>
            </div>
        </header>

        <div class="controls">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" class="search-box" placeholder="Search lore entries...">
                <button type="button" class="search-clear" id="searchClear" title="Clear search" aria-label="Clear search">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="controls-row">
                <button class="control-btn control-btn-icon" id="filtersBtn" title="Filters">
                    <i class="fa-solid fa-tag"></i>
                </button>
                <div class="sort-wrapper">
                    <select id="sortBy" class="sort-dropdown">
                        <option value="entry-asc">Oldest</option>
                        <option value="entry-desc">Newest</option>
                    </select>
                    <i class="fa-solid fa-chevron-down sort-chevron"></i>
                </div>
                <button class="control-btn control-btn-icon" id="addEntryBtn" title="Add entry">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <button class="control-btn control-btn-icon" id="tagEditorBtn" title="Edit Tags">
                    <i class="fa-solid fa-pen"></i>
                </button>
            </div>
            <div id="tagFilterContainer" class="tag-filter-container">
                <div id="tagFilter" class="tag-filter"></div>
            </div>
            <div id="tagEditContainer" class="controls-dropdown">
                <div class="controls-dropdown-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Edit Tag</h2>
                        <button class="modal-close" onclick="closeTagEditDropdown()">&times;</button>
                    </div>
                    <div class="tag-form-section">
                        <div style="margin: 15px 0;">
                            <label class="tag-form-label">Tag Name:</label>
                            <input type="text" id="tagEditName" class="tag-form-input">
                        </div>
                        <div style="margin: 15px 0;">
                            <label class="tag-form-label">Color:</label>
                            <div class="tag-form-color-selector">
                                <button type="button" class="tag-form-color-btn" data-color="purple" title="Purple"></button>
                                <button type="button" class="tag-form-color-btn" data-color="green" title="Green"></button>
                                <button type="button" class="tag-form-color-btn" data-color="blue" title="Blue"></button>
                                <button type="button" class="tag-form-color-btn" data-color="orange" title="Orange"></button>
                                <button type="button" class="tag-form-color-btn" data-color="teal" title="Teal"></button>
                                <button type="button" class="tag-form-color-btn" data-color="pink" title="Pink"></button>
                                <button type="button" class="tag-form-color-btn" data-color="amber" title="Amber"></button>
                                <button type="button" class="tag-form-color-btn selected" data-color="slate" title="Slate"></button>
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <label class="tag-form-label">Terms (one per line):</label>
                            <textarea id="tagEditTerms" class="tag-form-textarea"></textarea>
                        </div>
                        <div class="tag-form-buttons">
                            <button type="button" id="tagEditSubmit" class="tag-btn" style="flex: 1;">Update Tag</button>
                            <button type="button" onclick="closeTagEditDropdown()" class="tag-btn" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addEntryContainer" class="controls-dropdown lore-entry-tray">
                <div class="tray">
                    <div class="tray-header">
                        <div class="tray-header-title">
                            <h2>Lore entry</h2>
                            <input type="number" id="addEntryNumber" class="tray-header-entry-num" step="any" min="0" placeholder="#" tabindex="0" aria-label="Entry number" autocomplete="off">
                        </div>
                        <button type="button" class="tray-close" onclick="closeAddEntryModal()" aria-label="Close" tabindex="0">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="entry-content">
                        <h3>Content</h3>
                        <textarea id="addEntryContent" placeholder="Add your lore entry here..." tabindex="0" autocomplete="off"></textarea>
                    </div>
                    <div class="enter-tag">
                        <h3>Tags</h3>
                        <div class="tag-input-wrapper">
                            <input type="text" id="addEntryTagInput" placeholder="Add a tag..." tabindex="0" autocomplete="off">
                            <div class="edit-entry-color-wrapper" id="addEntryColorWrapper">
                                <button type="button" class="lore-tag-current-color edit-entry-color-swatch" id="addEntryColorSwatch" data-color="slate" aria-label="Tag color" title="Select color" tabindex="0"></button>
                                <div class="lore-tag-color-selector edit-entry-color-popover" role="group" aria-label="Tag color options">
                                    <button type="button" class="tag-color orange-red edit-entry-color-btn" data-color="amber" title="Amber" tabindex="0"></button>
                                    <button type="button" class="tag-color orange edit-entry-color-btn" data-color="orange" title="Orange" tabindex="0"></button>
                                    <button type="button" class="tag-color lime edit-entry-color-btn" data-color="green" title="Green" tabindex="0"></button>
                                    <button type="button" class="tag-color aqua edit-entry-color-btn" data-color="teal" title="Teal" tabindex="0"></button>
                                    <button type="button" class="tag-color blue edit-entry-color-btn" data-color="blue" title="Blue" tabindex="0"></button>
                                    <button type="button" class="tag-color purple edit-entry-color-btn" data-color="purple" title="Purple" tabindex="0"></button>
                                    <button type="button" class="tag-color magenta edit-entry-color-btn" data-color="pink" title="Pink" tabindex="0"></button>
                                    <button type="button" class="tag-color slate edit-entry-color-btn selected" data-color="slate" title="Slate" tabindex="0"></button>
                                </div>
                            </div>
                        </div>
                        <div id="addEntryTagAutocomplete" class="tag-autocomplete" style="display:none;"></div>
                        <div id="addEntryTags" class="tag-list"></div>
                    </div>
                    <div id="addEntrySuggestedTags" class="suggest-tag">
                        <div class="suggest-tag-header">
                            <h3>Suggested tags</h3>
                            <button type="button" class="add-all-tags-btn" id="addEntryAddAllSuggested" style="display: none;" tabindex="0">+ Add all tags</button>
                        </div>
                        <div id="addEntrySuggestedTagsList" class="tag-list"></div>
                    </div>
                    <div class="tray-footer">
                        <button type="button" class="generic-ui-btn text" data-action="cancel-add" tabindex="0">Cancel</button>
                        <button type="button" class="generic-ui-btn text purple-btn" data-action="submit-add" tabindex="0">Done</button>
                    </div>
                </div>
            </div>
            <div id="editEntryContainer" class="controls-dropdown lore-entry-tray">
                <div class="tray">
                    <div class="tray-header">
                        <h2>Lore entry</h2>
                        <button type="button" class="tray-close" onclick="closeEditEntryModal()" aria-label="Close" tabindex="0">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="entry-content">
                        <h3>Content</h3>
                        <textarea id="editEntryContent" placeholder="Add your lore entry here..." tabindex="0" autocomplete="off"></textarea>
                    </div>
                    <div class="enter-tag">
                        <h3>Tags</h3>
                        <div class="tag-input-wrapper">
                            <input type="text" id="editEntryTagInput" placeholder="Add a tag and press Enter..." tabindex="0" autocomplete="off">
                            <div class="edit-entry-color-wrapper" id="editEntryColorWrapper">
                                <button type="button" class="lore-tag-current-color edit-entry-color-swatch" id="editEntryColorSwatch" data-color="slate" aria-label="Tag color" title="Select color" tabindex="0"></button>
                                <div class="lore-tag-color-selector edit-entry-color-popover" role="group" aria-label="Tag color options">
                                    <button type="button" class="tag-color orange-red edit-entry-color-btn" data-color="amber" title="Amber" tabindex="0"></button>
                                    <button type="button" class="tag-color orange edit-entry-color-btn" data-color="orange" title="Orange" tabindex="0"></button>
                                    <button type="button" class="tag-color lime edit-entry-color-btn" data-color="green" title="Green" tabindex="0"></button>
                                    <button type="button" class="tag-color aqua edit-entry-color-btn" data-color="teal" title="Teal" tabindex="0"></button>
                                    <button type="button" class="tag-color blue edit-entry-color-btn" data-color="blue" title="Blue" tabindex="0"></button>
                                    <button type="button" class="tag-color purple edit-entry-color-btn" data-color="purple" title="Purple" tabindex="0"></button>
                                    <button type="button" class="tag-color magenta edit-entry-color-btn" data-color="pink" title="Pink" tabindex="0"></button>
                                    <button type="button" class="tag-color slate edit-entry-color-btn selected" data-color="slate" title="Slate" tabindex="0"></button>
                                </div>
                            </div>
                        </div>
                        <div id="editEntryTagAutocomplete" class="tag-autocomplete" style="display:none;"></div>
                        <div id="editEntryTags" class="tag-list"></div>
                    </div>
                    <div id="editEntrySuggestedTags" class="suggest-tag">
                        <div class="suggest-tag-header">
                            <h3>Suggested tags</h3>
                            <button type="button" class="add-all-tags-btn" id="editEntryAddAllSuggested" style="display: none;" tabindex="0">+ Add all tags</button>
                        </div>
                        <div id="editEntrySuggestedTagsList" class="tag-list"></div>
                    </div>
                    <div class="tray-footer">
                        <button type="button" class="generic-ui-btn" data-action="delete-edit" title="Delete entry" tabindex="0">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="generic-ui-btn text purple-btn" data-action="update-edit" tabindex="0">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="database" class="database-view"></div>

        <div id="emptyState" class="empty-state">
            <p>No entries match your filters</p>
        </div>

        <div id="errorState" class="empty-state">
            <p>⚠️ Failed to load data from Google Sheets</p>
            <p>Please check that the sheet is published and try refreshing.</p>
        </div>

        <div id="tagContextMenu" class="tag-context-menu">
            <button type="button" class="tag-context-menu-item" data-action="edit">Edit tag</button>
            <button type="button" class="tag-context-menu-item" data-action="delete">Delete tag</button>
        </div>

        <div class="stats">
            Showing <span id="resultCount">0</span> of <span id="totalCount">0</span> entries / <span id="dataSource">loading...</span>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-number" id="modalNumber"></div>
                    <h2 class="modal-title" id="modalTitle"></h2>
                </div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-description" id="modalDescription"></div>
            <div class="modal-tags" id="modalTags"></div>
        </div>
    </div>

    <!-- Tag Editor Modal -->
    <div id="tagEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Tag Editor</h2>
                <button class="modal-close" onclick="closeTagEditor()">&times;</button>
            </div>

            <div class="tag-editor-search-wrapper">
                <i class="fa-solid fa-magnifying-glass tag-editor-search-icon"></i>
                <input type="text" id="tagEditorSearch" class="tag-editor-search-input" placeholder="Search tags...">
            </div>

            <div id="tagFormHome">
            <div id="tagForm" class="tag-form-section">
                <h3 id="tagFormTitle" class="tag-form-title"></h3>
                <div style="margin: 15px 0;">
                    <label class="tag-form-label">Tag Name:</label>
                    <input type="text" id="tagName" class="tag-form-input">
                </div>
                <div style="margin: 15px 0;">
                    <label class="tag-form-label">Color:</label>
                    <div class="tag-form-color-selector">
                        <button type="button" class="tag-form-color-btn" data-color="purple" title="Purple"></button>
                        <button type="button" class="tag-form-color-btn" data-color="green" title="Green"></button>
                        <button type="button" class="tag-form-color-btn" data-color="blue" title="Blue"></button>
                        <button type="button" class="tag-form-color-btn" data-color="orange" title="Orange"></button>
                        <button type="button" class="tag-form-color-btn" data-color="teal" title="Teal"></button>
                        <button type="button" class="tag-form-color-btn" data-color="pink" title="Pink"></button>
                        <button type="button" class="tag-form-color-btn" data-color="amber" title="Amber"></button>
                        <button type="button" class="tag-form-color-btn selected" data-color="slate" title="Slate"></button>
                    </div>
                </div>
                <div style="margin: 15px 0;">
                    <label class="tag-form-label">Terms (one per line):</label>
                    <textarea id="tagTerms" class="tag-form-textarea"></textarea>
                </div>
                <div class="tag-form-buttons">
                    <button onclick="submitTagForm()" id="tagFormSubmit" class="tag-btn" style="flex: 1;">Create Tag</button>
                    <button onclick="cancelTagForm()" class="tag-btn" style="flex: 1;">Cancel</button>
                </div>
            </div>
            </div>

            <button onclick="showNewTagForm()" class="tag-btn" style="margin-bottom: 20px;">+ New Tag</button>

            <div id="tagList"></div>

            <div class="tag-editor-divider">
                <button onclick="downloadTags()" class="tag-btn">⬇️ Download tags.json</button>
            </div>
        </div>
    </div>

    <!-- Global state -->
    <script>
        let allData = [];
        let filteredData = [];
        let selectedTags = new Set();
        let selectedCustomTags = new Set();
        let searchTerm = '';
        let filtersVisible = false;
    </script>

    <!-- Firebase -->
    <script src="js/firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="js/firebase-db.js"></script>
    <script src="js/auth.js"></script>

    <!-- JSONBin backup (optional - no-op if not configured) -->
    <script src="js/jsonbin-config.js"></script>
    <script src="js/jsonbin-backup.js"></script>

    <!-- External scripts -->
    <script src="js/utils.js"></script>
    <script src="js/tag-manager.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/filter.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/tag-editor.js"></script>
    <script src="js/app.js"></script>
    <script src="js/tag-autocomplete.js"></script>
</body>

</html>