<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noxsyphone Loredump</title>
    <link rel="icon" href="img/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/keyboard-shortcuts.css">

</head>

<body>


    <!-- Sign-in screen (shown when not authenticated) -->
    <div id="signInScreen" class="sign-in-screen">
        <div class="sign-in-card">
            <img src="img/raygun.svg" alt="" class="sign-in-logo">
            <!-- <h1 class="sign-in-title">Noxsyphone Lore Dump</h1> -->
            <p class="sign-in-subtitle">Identity verification required.</p>
            <button type="button" id="signInBtn" class="sign-in-btn">
                <svg class="icon" aria-hidden="true">
                    <use href="img/sprites/brands.svg#google"></use>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main app (shown when authenticated) -->
    <div id="appContent" class="container app-layout" style="display: none;">
        <div class="app-main-content">
            <div class="controls">
                <header>
                    <img src="img/raygun.svg" alt="raygun">
                    <h1>Noxsyphone Lore Dump</h1>
                    <div class="header-actions">
                        <span id="userEmail" class="user-email"></span>
                        <button id="signOutBtn" class="generic-ui-btn" title="Sign out">
                            <svg class="icon" aria-hidden="true">
                                <use href="img/sprites/duotone.svg#arrow-right-from-bracket"></use>
                            </svg>
                        </button>
                    </div>
                </header>
                <div class="search-add-row">
                    <div class="search-wrapper">
                        <svg class="icon search-icon" aria-hidden="true">
                            <use href="img/sprites/regular.svg#magnifying-glass"></use>
                        </svg>
                        <input type="text" id="searchInput" class="search-box" placeholder="Search lore entries..."
                            autocomplete="off">
                        <button type="button" class="search-clear" id="searchClear" title="Clear search"
                            aria-label="Clear search">
                            <svg class="icon" aria-hidden="true">
                                <use href="img/sprites/duotone.svg#xmark"></use>
                            </svg>
                        </button>
                    </div>
                    <button class="generic-ui-btn purple-btn" id="addEntryBtn" title="Add entry">
                        <i class="fa-solid fa-plus"></i>
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/solid.svg#plus"></use>
                        </svg>
                    </button>
                </div>
                <div class="controls-row">
                    <button class="generic-ui-btn" id="filtersBtn" title="Filters">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/regular.svg#filter"></use>
                        </svg>
                    </button>
                    <div class="goto-entry-wrapper">
                        <input type="number" id="gotoEntry" class="goto-entry-input" placeholder="Entry #" step="any"
                            min="0">
                    </div>
                    <select id="sortBy" class="sort-dropdown-native" aria-hidden="true" tabindex="-1"
                        style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;">
                        <option value="entry-asc">Oldest</option>
                        <option value="entry-desc">Newest</option>
                    </select>
                    <button class="generic-ui-btn" id="tagEditorBtn" title="Edit Tags">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/duotone.svg#pen"></use>
                        </svg>
                    </button>
                    <div class="sort-control-wrapper">
                        <button class="generic-ui-btn text-btn dropdown-btn" id="sortBtn" title="Change Sort Order">
                            <span id="sortBtnText">Oldest First</span>
                            <svg class="icon" aria-hidden="true">
                                <use href="img/sprites/solid.svg#caret-down"></use>
                            </svg>
                        </button>
                        <!-- Sort Dropdown Menu -->
                        <div id="sortDropdown" class="controls-dropdown">
                            <div class="controls-dropdown-content sort-dropdown-content">
                                <button class="sort-option" data-value="entry-asc">Oldest First</button>
                                <button class="sort-option" data-value="entry-desc">Newest First</button>
                            </div>
                        </div>
                    </div>
                    <button class="generic-ui-btn" id="scrollToTopBtn" title="To top" aria-label="Scroll to top">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/solid.svg#chevron-up"></use>
                        </svg>
                    </button>
                    <button class="generic-ui-btn" id="scrollToBottomBtn" title="To bottom" aria-label="Scroll to bottom">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/solid.svg#chevron-down"></use>
                        </svg>
                    </button>
                </div>
                <div id="tagEditContainer" class="controls-dropdown">
                    <div class="controls-dropdown-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit Tag</h2>
                            <button class="modal-close close-btn" onclick="closeTagEditDropdown()">&times;</button>
                        </div>
                        <div class="tag-form-section">
                            <div style="margin: 15px 0;">
                                <label class="tag-form-label">Tag Name:</label>
                                <input type="text" id="tagEditName" class="tag-form-input">
                            </div>
                            <div style="margin: 15px 0;">
                                <label class="tag-form-label">Color:</label>
                                <div class="tag-form-color-selector">
                                    <button type="button" class="tag-form-color-btn" data-color="purple"
                                        title="Purple"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="green"
                                        title="Green"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="blue"
                                        title="Blue"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="orange"
                                        title="Orange"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="teal"
                                        title="Teal"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="pink"
                                        title="Pink"></button>
                                    <button type="button" class="tag-form-color-btn" data-color="amber"
                                        title="Amber"></button>
                                    <button type="button" class="tag-form-color-btn selected" data-color="slate"
                                        title="Slate"></button>
                                </div>
                            </div>
                            <div style="margin: 15px 0;">
                                <label class="tag-form-label">Terms (one per line):</label>
                                <textarea id="tagEditTerms" class="tag-form-textarea"></textarea>
                            </div>
                            <div class="tag-form-buttons">
                                <button type="button" id="tagEditSubmit" class="tag-btn" style="flex: 1;">Update
                                    Tag</button>
                                <button type="button" onclick="closeTagEditDropdown()" class="tag-btn"
                                    style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="editEntryContainer" class="controls-dropdown lore-entry-tray">
                    <div class="tray">
                        <div class="tray-header">
                            <h2>Lore entry</h2>
                            <div class="tray-header-actions">
                                <input type="number" id="editEntryNumber" class="tray-header-entry-num" step="any"
                                    min="0" placeholder="#" tabindex="0" aria-label="Entry number" autocomplete="off">
                                <button type="button" class="generic-ui-btn" data-action="delete-edit"
                                    title="Delete entry" tabindex="0">
                                    <svg class="icon" aria-hidden="true">
                                        <use href="img/sprites/duotone.svg#trash"></use>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="entry-content">
                            <h3>Content</h3>
                            <textarea id="editEntryContent" placeholder="Add your lore entry here..." tabindex="0"
                                autocomplete="off"></textarea>
                        </div>
                        <div class="enter-tag">
                            <h3>Tags</h3>
                            <div class="tag-input-row">
                                <div class="tag-input-wrapper">
                                <input type="text" id="editEntryTagInput" placeholder="Add a tag and press Enter..."
                                    tabindex="0" autocomplete="off">
                                <div id="editEntryTagAutocomplete" class="tag-autocomplete" style="display:none;"></div>
                                <div class="edit-entry-color-wrapper" id="editEntryColorWrapper">
                                    <button type="button" class="lore-tag-current-color edit-entry-color-swatch"
                                        id="editEntryColorSwatch" data-color="slate" aria-label="Tag color"
                                        title="Select color" tabindex="0"></button>
                                    <div class="lore-tag-color-selector edit-entry-color-popover" role="group"
                                        aria-label="Tag color options">
                                        <button type="button" class="tag-color orange-red edit-entry-color-btn"
                                            data-color="amber" title="Amber" tabindex="0"></button>
                                        <button type="button" class="tag-color orange edit-entry-color-btn"
                                            data-color="orange" title="Orange" tabindex="0"></button>
                                        <button type="button" class="tag-color lime edit-entry-color-btn"
                                            data-color="green" title="Green" tabindex="0"></button>
                                        <button type="button" class="tag-color aqua edit-entry-color-btn"
                                            data-color="teal" title="Teal" tabindex="0"></button>
                                        <button type="button" class="tag-color blue edit-entry-color-btn"
                                            data-color="blue" title="Blue" tabindex="0"></button>
                                        <button type="button" class="tag-color purple edit-entry-color-btn"
                                            data-color="purple" title="Purple" tabindex="0"></button>
                                        <button type="button" class="tag-color magenta edit-entry-color-btn"
                                            data-color="pink" title="Pink" tabindex="0"></button>
                                        <button type="button" class="tag-color slate edit-entry-color-btn selected"
                                            data-color="slate" title="Slate" tabindex="0"></button>
                                    </div>
                                </div>
                                </div>
                            </div>
                            <div id="editEntryTags" class="tag-list"></div>
                        </div>
                        <div id="editEntrySuggestedTags" class="suggest-tag">
                            <div class="suggest-tag-header">
                                <h3>Suggested tags</h3>
                                <button type="button" class="add-all-tags-btn" id="editEntryAddAllSuggested"
                                    style="display: none;" tabindex="0">+ Add all tags</button>
                            </div>
                            <div id="editEntrySuggestedTagsList" class="tag-list"></div>
                        </div>
                        <div class="tray-footer">
                            <span class="tray-save-message" id="editTraySaveMessage" aria-live="polite"></span>
                            <button type="button" class="generic-ui-btn text purple-btn" data-action="update-edit"
                                tabindex="0">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="database" class="database-view"></div>

            <div id="emptyState" class="empty-state">
                <p>No entries match your filters</p>
            </div>

            <div id="errorState" class="empty-state">
                <p>⚠️ Failed to load data from Google Sheets</p>
                <p>Please check that the sheet is published and try refreshing.</p>
            </div>

            <div class="stats">
                Showing <span id="resultCount">0</span> of <span id="totalCount">0</span> entries / <span
                    id="dataSource">loading...</span>
            </div>
        </div>

        <!-- Filter Sidesheet -->
        <div id="filterSidesheet" class="sidesheet filter-sidesheet" aria-hidden="true">
            <div class="sidesheet-panel">
                <div class="sidesheet-header">
                    <h2 class="sidesheet-title">Filters</h2>
                    <button type="button" class="sidesheet-close" id="filterSidesheetClose" aria-label="Close">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/duotone.svg#xmark"></use>
                        </svg>
                    </button>
                </div>
                <div class="sidesheet-content">
                    <div class="tag-filter-search-wrapper">
                        <svg class="icon tag-filter-search-icon" aria-hidden="true">
                            <use href="img/sprites/regular.svg#magnifying-glass"></use>
                        </svg>
                        <input type="text" id="tagFilterSearch" class="tag-filter-search" placeholder="Search tags..."
                            autocomplete="off" aria-label="Search tags">
                        <button type="button" class="search-clear" id="tagFilterSearchClear" title="Clear search"
                            aria-label="Clear search">
                            <svg class="icon" aria-hidden="true">
                                <use href="img/sprites/duotone.svg#xmark"></use>
                            </svg>
                        </button>
                    </div>
                    <!-- <div class="filter-sidesheet-section">
                        <h3 class="filter-sidesheet-section-title">Sort by</h3>
                        <div class="filter-sidesheet-sort-options">
                            <label class="filter-sidesheet-sort-option">
                                <input type="radio" name="sidesheetSort" value="entry-asc" checked>
                                <span>Oldest first</span>
                            </label>
                            <label class="filter-sidesheet-sort-option">
                                <input type="radio" name="sidesheetSort" value="entry-desc">
                                <span>Newest first</span>
                            </label>
                        </div>
                    </div> -->
                    <div class="filter-sidesheet-section">
                        <div class="filter-sidesheet-section-header">
                            <h3 class="filter-sidesheet-section-title">Filter by tags</h3>
                            <div class="filter-sidesheet-section-actions">
                                <span id="tagFilterCount" class="tag-filter-count" style="display: none;">0</span>
                                <button type="button" id="tagFilterClearAll" class="tag-filter-clear-all"
                                    style="display: none;">Clear</button>
                            </div>
                        </div>
                        <div id="tagFilterActive" class="tag-filter-active">
                            <span class="tag-filter-label">Active filters</span>
                            <div id="tagFilterActiveList" class="tag-filter-list"></div>
                        </div>
                        <div id="tagFilterAvailable" class="tag-filter-available">
                            <!-- <span class="tag-filter-label">All tags</span> -->
                            <div id="tagFilter" class="tag-filter"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tag Editor Sidesheet -->
        <div id="tagEditorSidesheet" class="sidesheet tag-editor-sidesheet" aria-hidden="true">
            <div class="sidesheet-panel">
                <div class="sidesheet-header">
                    <h2 class="sidesheet-title">Edit Tags</h2>
                    <button type="button" class="sidesheet-close" id="tagEditorSidesheetClose" aria-label="Close">
                        <svg class="icon" aria-hidden="true">
                            <use href="img/sprites/duotone.svg#xmark"></use>
                        </svg>
                    </button>
                </div>
                <div class="sidesheet-content">
                    <div class="search-add-row">
                        <div class="tag-filter-search-wrapper">
                            <svg class="icon tag-filter-search-icon" aria-hidden="true">
                                <use href="img/sprites/regular.svg#magnifying-glass"></use>
                            </svg>
                            <input type="text" id="tagEditorSearch" class="tag-filter-search" placeholder="Search tags..." autocomplete="off" aria-label="Search tags">
                            <button type="button" class="search-clear" id="tagEditorSearchClear" title="Clear search" aria-label="Clear search">
                                <svg class="icon" aria-hidden="true">
                                    <use href="img/sprites/duotone.svg#xmark"></use>
                                </svg>
                            </button>
                        </div>
                        <button type="button" class="generic-ui-btn purple-btn" id="tagEditorNewTagBtn" title="New tag" aria-label="New tag" onclick="showNewTagForm()">
                            <svg class="icon" aria-hidden="true">
                                <use href="img/sprites/solid.svg#plus"></use>
                            </svg>
                        </button>
                    </div>
                    <div id="tagFormHome">
                        <div id="tagForm" class="tag-form-section">
                            <h3 id="tagFormTitle" class="tag-form-title"></h3>
                            <div class="tag-input-row" style="margin: 15px 0;">
                                <div class="tag-input-wrapper">
                                    <input type="text" id="tagName" placeholder="Tag name..." autocomplete="off" aria-label="Tag name">
                                    <div class="edit-entry-color-wrapper" id="tagEditorColorWrapper">
                                        <button type="button" class="lore-tag-current-color edit-entry-color-swatch" id="tagEditorColorSwatch" data-color="slate" aria-label="Tag color" title="Select color"></button>
                                        <div class="lore-tag-color-selector edit-entry-color-popover" role="group" aria-label="Tag color options">
                                            <button type="button" class="tag-color orange-red edit-entry-color-btn" data-color="amber" title="Amber"></button>
                                            <button type="button" class="tag-color orange edit-entry-color-btn" data-color="orange" title="Orange"></button>
                                            <button type="button" class="tag-color lime edit-entry-color-btn" data-color="green" title="Green"></button>
                                            <button type="button" class="tag-color aqua edit-entry-color-btn" data-color="teal" title="Teal"></button>
                                            <button type="button" class="tag-color blue edit-entry-color-btn" data-color="blue" title="Blue"></button>
                                            <button type="button" class="tag-color purple edit-entry-color-btn" data-color="purple" title="Purple"></button>
                                            <button type="button" class="tag-color magenta edit-entry-color-btn" data-color="pink" title="Pink"></button>
                                            <button type="button" class="tag-color slate edit-entry-color-btn selected" data-color="slate" title="Slate"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 15px 0;">
                                <label class="tag-form-label">Terms (one per line):</label>
                                <textarea id="tagTerms" class="tag-form-textarea"></textarea>
                            </div>
                            <div class="tag-form-buttons">
                                <button type="button" onclick="submitTagForm()" id="tagFormSubmit" class="tag-btn" style="flex: 1;">Create Tag</button>
                                <button type="button" onclick="cancelTagForm()" class="tag-btn" style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="tagList"></div>
                    <div class="tag-editor-divider">
                        <button type="button" onclick="downloadTags()" class="tag-btn">⬇️ Download tags.json</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Add Entry Modal -->
    <div id="addEntryContainer" class="modal add-entry-modal">
        <div class="modal-content lore-entry-tray">
            <div class="tray">
                <div class="tray-header">
                    <h2>Lore entry</h2>
                    <input type="number" id="addEntryNumber" class="tray-header-entry-num" step="any" min="0"
                        placeholder="#" tabindex="0" aria-label="Entry number" autocomplete="off">
                </div>
                <div class="entry-content">
                    <h3>Content</h3>
                    <textarea id="addEntryContent" placeholder="Add your lore entry here..." tabindex="0"
                        autocomplete="off"></textarea>
                </div>
                <div class="enter-tag">
                    <h3>Tags</h3>
                    <div class="tag-input-row">
                        <div class="tag-input-wrapper">
                        <input type="text" id="addEntryTagInput" placeholder="Add a tag..." tabindex="0"
                            autocomplete="off">
                        <div id="addEntryTagAutocomplete" class="tag-autocomplete" style="display:none;"></div>
                        <div class="edit-entry-color-wrapper" id="addEntryColorWrapper">
                            <button type="button" class="lore-tag-current-color edit-entry-color-swatch"
                                id="addEntryColorSwatch" data-color="slate" aria-label="Tag color" title="Select color"
                                tabindex="0"></button>
                            <div class="lore-tag-color-selector edit-entry-color-popover" role="group"
                                aria-label="Tag color options">
                                <button type="button" class="tag-color orange-red edit-entry-color-btn"
                                    data-color="amber" title="Amber" tabindex="0"></button>
                                <button type="button" class="tag-color orange edit-entry-color-btn" data-color="orange"
                                    title="Orange" tabindex="0"></button>
                                <button type="button" class="tag-color lime edit-entry-color-btn" data-color="green"
                                    title="Green" tabindex="0"></button>
                                <button type="button" class="tag-color aqua edit-entry-color-btn" data-color="teal"
                                    title="Teal" tabindex="0"></button>
                                <button type="button" class="tag-color blue edit-entry-color-btn" data-color="blue"
                                    title="Blue" tabindex="0"></button>
                                <button type="button" class="tag-color purple edit-entry-color-btn" data-color="purple"
                                    title="Purple" tabindex="0"></button>
                                <button type="button" class="tag-color magenta edit-entry-color-btn" data-color="pink"
                                    title="Pink" tabindex="0"></button>
                                <button type="button" class="tag-color slate edit-entry-color-btn selected"
                                    data-color="slate" title="Slate" tabindex="0"></button>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div id="addEntryTags" class="tag-list"></div>
                </div>
                <div id="addEntrySuggestedTags" class="suggest-tag">
                    <div class="suggest-tag-header">
                        <h3>Suggested tags</h3>
                        <button type="button" class="add-all-tags-btn" id="addEntryAddAllSuggested"
                            style="display: none;" tabindex="0">+ Add all tags</button>
                    </div>
                    <div id="addEntrySuggestedTagsList" class="tag-list"></div>
                </div>
                <div class="tray-footer">
                    <span class="tray-save-message" id="addTraySaveMessage" aria-live="polite"></span>
                    <div class="tray-footer-buttons">
                        <!-- <button type="button" class="generic-ui-btn text" data-action="cancel-add" tabindex="0">Cancel</button> -->
                        <button type="button" class="generic-ui-btn text purple-btn" data-action="submit-add"
                            tabindex="0">Add Entry</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-number" id="modalNumber"></div>
                    <h2 class="modal-title" id="modalTitle"></h2>
                </div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-description" id="modalDescription"></div>
            <div class="modal-tags" id="modalTags"></div>
        </div>
    </div>

    <!-- Global state -->
    <script>
        let allData = [];
        let filteredData = [];
        let selectedTags = new Set();
        let selectedCustomTags = new Set();
        let searchTerm = '';
        let filtersVisible = false;
    </script>

    <!-- Firebase -->
    <script src="js/firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="js/firebase-db.js"></script>
    <script src="js/auth.js"></script>

    <!-- GitHub backup (now handled via GitHub Actions; browser no longer needs a token) -->
    <script src="js/github-backup.js"></script>

    <!-- External scripts -->
    <script src="js/utils.js"></script>
    <script src="js/tag-manager.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/filter.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/tag-editor.js"></script>
    <script src="js/app.js"></script>
    <script src="js/tag-autocomplete.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/keyboard-shortcuts.js"></script>
</body>

</html>